{% extends "receptionist/base_receptionist.html" %}
{% block title %}Appointments - Receptionist Panel{% endblock %}
{% block page_title %}Appointments{% endblock %}
{% block breadcrumb %}
<li class="breadcrumb-item active" aria-current="page">Appointments</li>
{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <div class="receptionist-card">
            <div class="receptionist-card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-calendar-check me-2"></i>
                    All Appointments
                </h4>
                <a href="{{ url_for('receptionist.create_appointment') }}" class="btn btn-light">
                    <i class="fas fa-calendar-plus me-2"></i>
                    Create Appointment
                </a>
            </div>
            <div class="receptionist-card-body">
                <div class="search-header">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search by Name</label>
                            <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}" placeholder="Search patient or doctor name...">
                        </div>
                        <div class="col-md-3">
                            <label for="date" class="form-label">Filter by Date</label>
                            <input type="date" class="form-control" id="date" name="date" value="{{ date_filter }}">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Filter by Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="all" {% if status_filter=='all' %}selected{% endif %}>All Status</option>
                                <option value="scheduled" {% if status_filter=='scheduled' %}selected{% endif %}>Scheduled</option>
                                <option value="confirmed" {% if status_filter=='confirmed' %}selected{% endif %}>Confirmed</option>
                                <option value="under_consultation" {% if status_filter=='under_consultation' %}selected{% endif %}>Under Consultation</option>
                                <option value="completed" {% if status_filter=='completed' %}selected{% endif %}>Completed</option>
                                <option value="cancelled" {% if status_filter=='cancelled' %}selected{% endif %}>Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100 me-2">
                                <i class="fas fa-filter me-2"></i>Apply
                            </button>
                            {% if search_query or date_filter or status_filter != 'all' %}
                            <a href="{{ url_for('receptionist.receptionist_appointments') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
                {% if search_query or date_filter or status_filter != 'all' %}
                <div class="mt-3">
                    <small class="text-muted">Active filters: </small>
                    {% if search_query %}
                    <span class="badge bg-primary filter-badge" onclick="clearFilter('search')">
                        Search: "{{ search_query }}" <i class="fas fa-times ms-1"></i>
                    </span>
                    {% endif %}
                    {% if date_filter %}
                    <span class="badge bg-info filter-badge" onclick="clearFilter('date')">
                        Date: {{ date_filter }} <i class="fas fa-times ms-1"></i>
                    </span>
                    {% endif %}
                    {% if status_filter != 'all' %}
                    <span class="badge bg-warning filter-badge" onclick="clearFilter('status')">
                        Status: {{ status_filter|title }} <i class="fas fa-times ms-1"></i>
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% if search_query or date_filter or status_filter != 'all' %}
            <div class="mt-3">
                <small class="text-muted">
                    Active filters:
                    {% if search_query %}<span class="badge bg-secondary">{{ search_query }}</span>{% endif %}
                    {% if date_filter %}<span class="badge bg-secondary">Date: {{ date_filter }}</span>{% endif %}
                    {% if status_filter != 'all' %}<span class="badge bg-secondary">Status: {{ status_filter }}</span>{% endif %}
                    <a href="{{ url_for('receptionist.receptionist_appointments') }}" class="text-danger ms-2">
                        <i class="fas fa-times"></i> Clear all
                    </a>
                </small>
            </div>
            {% endif %}
        </div>
        {% if appointments %}
                {% set current_date = date_filter if date_filter else (now().strftime('%Y-%m-%d')) %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Patient</th>
                                <th>Doctor</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# 1. Under Consultation #}
                            {% for appointment in appointments if appointment.status == 'under_consultation' %}
                                <tr data-doctor-id="{{ appointment.doctor.id }}" data-appointment-id="{{ appointment.id }}" class="table-warning">
                                    <td>{{ appointment.id }}</td>
                                    <td>{{ appointment.user.full_name if appointment.user else 'N/A' }}</td>
                                    <td>{{ appointment.doctor.full_name if appointment.doctor else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') if appointment.appointment_date else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_time.strftime('%H:%M') if appointment.appointment_time else 'N/A' }}</td>
                                    <td>{{ appointment.symptoms if appointment.symptoms else 'N/A' }}</td>
                                    <td><span class="badge bg-warning">{{ appointment.display_status }}</span></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if appointment.status not in ['completed','cancelled'] %}
                                            <button class="btn btn-sm btn-warning" onclick="editAppointment('{{ appointment.id }}')"><i class="fas fa-edit"></i></button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-primary" onclick="openIntakeReadonly('{{ appointment.user.id }}')"><i class="fa fa-info-circle"></i></button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="openTimelineModal('{{ appointment.user.id }}')"><i class="fa-solid fa-timeline"></i></button>
                                            <button class="btn btn-sm btn-outline-success" onclick="viewPrescription('{{ appointment.id }}')"><i class="fa-solid fa-file-medical"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment('{{ appointment.id }}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            {% for appointment in appointments if appointment.status == 'confirmed' and appointment.appointment_date.strftime('%Y-%m-%d') == current_date %}
                                <tr data-doctor-id="{{ appointment.doctor.id }}" class="table-primary">
                                    <td>{{ appointment.id }}</td>
                                    <td>{{ appointment.user.full_name if appointment.user else 'N/A' }}</td>
                                    <td>{{ appointment.doctor.full_name if appointment.doctor else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') if appointment.appointment_date else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_time.strftime('%H:%M') if appointment.appointment_time else 'N/A' }}</td>
                                    <td>{{ appointment.symptoms if appointment.symptoms else 'N/A' }}</td>
                                    <td><span class="badge bg-info">{{ appointment.display_status }}</span></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-warning" onclick="editAppointment('{{ appointment.id }}')"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-sm btn-primary" onclick="openIntakeReadonly('{{ appointment.user.id }}')"><i class="fa fa-info-circle"></i></button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="openTimelineModal('{{ appointment.user.id }}')"><i class="fa-solid fa-timeline"></i></button>
                                            <button class="btn btn-sm btn-outline-success" onclick="viewPrescription('{{ appointment.id }}')"><i class="fa-solid fa-file-medical"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment('{{ appointment.id }}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            {# 2. Today's Scheduled #}
                            {% for appointment in appointments if appointment.status == 'scheduled' and appointment.appointment_date.strftime('%Y-%m-%d') == current_date %}
                                <tr data-doctor-id="{{ appointment.doctor.id }}" class="table-info">
                                    <td>{{ appointment.id }}</td>
                                    <td>{{ appointment.user.full_name if appointment.user else 'N/A' }}</td>
                                    <td>{{ appointment.doctor.full_name if appointment.doctor else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') if appointment.appointment_date else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_time.strftime('%H:%M') if appointment.appointment_time else 'N/A' }}</td>
                                    <td>{{ appointment.symptoms if appointment.symptoms else 'N/A' }}</td>
                                    <td><span class="badge bg-info">{{ appointment.display_status }}</span></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-warning" onclick="editAppointment('{{ appointment.id }}')"><i class="fas fa-edit"></i></button>
                                            <button class="btn btn-sm btn-primary" onclick="openIntakeReadonly('{{ appointment.user.id }}')"><i class="fa fa-info-circle"></i></button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="openTimelineModal('{{ appointment.user.id }}')"><i class="fa-solid fa-timeline"></i></button>
                                            <button class="btn btn-sm btn-outline-success" onclick="viewPrescription('{{ appointment.id }}')"><i class="fa-solid fa-file-medical"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment('{{ appointment.id }}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}


                            

                            {# 3. All other appointments (confirmed, completed, remaining scheduled) #}
                            {% for appointment in appointments if appointment.status == 'completed' and appointment.appointment_date.strftime('%Y-%m-%d') == current_date %}
                                {% set badge_color = 'success' if appointment.status == 'completed' else ('info' if appointment.status == 'scheduled' else 'secondary') %}
                                <tr data-doctor-id="{{ appointment.doctor.id }}" >
                                    <td>{{ appointment.id }}</td>
                                    <td>{{ appointment.user.full_name if appointment.user else 'N/A' }}</td>
                                    <td>{{ appointment.doctor.full_name if appointment.doctor else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') if appointment.appointment_date else 'N/A' }}</td>
                                    <td>{{ appointment.appointment_time.strftime('%H:%M') if appointment.appointment_time else 'N/A' }}</td>
                                    <td>{{ appointment.symptoms if appointment.symptoms else 'N/A' }}</td>
                                    <td><span class="badge bg-{{ badge_color }}">{{ appointment.display_status }}</span></td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if appointment.status not in ['completed','cancelled'] %}
                                            <button class="btn btn-sm btn-warning" onclick="editAppointment('{{ appointment.id }}')"><i class="fas fa-edit"></i></button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-primary" onclick="openIntakeReadonly('{{ appointment.user.id }}')"><i class="fa fa-info-circle"></i></button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="openTimelineModal('{{ appointment.user.id }}')"><i class="fa-solid fa-timeline"></i></button>
                                            <button class="btn btn-sm btn-outline-success" onclick="viewPrescription('{{ appointment.id }}')"><i class="fa-solid fa-file-medical"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteAppointment('{{ appointment.id }}')"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-check fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No Appointments Found</h4>
                    <p class="text-muted">Start by creating your first appointment.</p>
                    <a href="{{ url_for('receptionist.create_appointment') }}" class="btn btn-receptionist-primary">
                        <i class="fas fa-calendar-plus me-2"></i>Create First Appointment
                    </a>
                </div>
            {% endif %}
    </div>
</div>
</div>
</div>
<!-- Added Appointment Details Modal -->
<div class="modal fade" id="appointmentDetailsModal" tabindex="-1" aria-labelledby="appointmentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="appointmentDetailsModalLabel">
                    <i class="fas fa-calendar-check me-2"></i>
                    Appointment Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="appointmentDetailsContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
<!-- Added Edit Appointment Modal -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editAppointmentModalLabel">
                    <i class="fas fa-edit me-2"></i>
                    Edit Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editAppointmentForm">
                    <input type="hidden" id="editAppointmentId" name="appointment_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editAppointmentDate" class="form-label">Appointment Date *</label>
                            <input type="date" class="form-control" id="editAppointmentDate" name="appointment_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editAppointmentTime" class="form-label">Appointment Time *</label>
                            <input type="time" class="form-control" id="editAppointmentTime" name="appointment_time" required>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="editAppointmentSymptoms" class="form-label">Symptoms/Reason</label>
                            <textarea class="form-control" id="editAppointmentSymptoms" name="symptoms" rows="3" placeholder="Enter symptoms or reason for appointment"></textarea>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="editAppointmentStatus" class="form-label">Status *</label>
                            <select class="form-control" id="editAppointmentStatus" name="status" required>
                                <option value="scheduled">Scheduled</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="under_consultation">Under Consultation</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditAppointment()">
                    <i class="fas fa-save me-2"></i>
                    Update Appointment
                </button>
            </div>
        </div>
    </div>
</div>
<style>
.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: none;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
}

.form-control:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
}

.btn-group .btn {
    margin-right: 0.25rem;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

.filter-badge {
    cursor: pointer;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    display: inline-block;
}

.filter-badge:hover {
    opacity: 0.8;
}
</style>
<script>
function viewAppointment(appointmentId) {
    fetch(`{{ url_for("receptionist.receptionist_appointment_details", appointment_id=0) }}`.replace('0', appointmentId))
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const appointment = data.appointment;
                const content = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Patient Information</h6>
                        <p><strong>Patient:</strong> ${appointment.patient_name}</p>
                        <p><strong>Mobile:</strong> ${appointment.patient_mobile}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Doctor Information</h6>
                        <p><strong>Doctor:</strong> ${appointment.doctor_name}</p>
                        <p><strong>Specialization:</strong> ${appointment.doctor_specialization}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Appointment Details</h6>
                        <p><strong>Date:</strong> ${appointment.appointment_date}</p>
                        <p><strong>Time:</strong> ${appointment.appointment_time}</p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Status & Info</h6>
                        <p><strong>Status:</strong> 
                            <span class="badge bg-${appointment.status === 'completed' ? 'success' : (appointment.status === 'scheduled' ? 'warning' : 'danger')}">
                                ${appointment.status.charAt(0).toUpperCase() + appointment.status.slice(1)}
                            </span>
                        </p>
                        <p><strong>Created:</strong> ${appointment.created_at}</p>
                    </div>
                    <div class="col-12">
                        <h6 class="text-primary">Symptoms/Reason</h6>
                        <p>${appointment.symptoms}</p>
                    </div>
                </div>
            `;
                document.getElementById('appointmentDetailsContent').innerHTML = content;
                const modal = new bootstrap.Modal(document.getElementById('appointmentDetailsModal'));
                modal.show();
            }
        });
}

function editAppointment(appointmentId) {
    fetch(`{{ url_for("receptionist.edit_appointment_page", appointment_id=0) }}`.replace('0', appointmentId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.appointment) {
                // Defensive: check all modal elements exist before setting value
                const idEl = document.getElementById('editAppointmentId');
                const dateEl = document.getElementById('editAppointmentDate');
                const timeEl = document.getElementById('editAppointmentTime');
                const symptomsEl = document.getElementById('editAppointmentSymptoms');
                const statusEl = document.getElementById('editAppointmentStatus');
                if (idEl) idEl.value = data.appointment.id;
                if (dateEl) dateEl.value = data.appointment.appointment_date;
                if (timeEl) timeEl.value = data.appointment.appointment_time;
                if (symptomsEl) symptomsEl.value = data.appointment.symptoms;
                if (statusEl) statusEl.value = data.appointment.status;
                const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
                modal.show();
            } else {
                showAlert('danger', data.message || 'Failed to load appointment details');
            }
        })
        .catch(error => {
            console.error('Error loading appointment:', error);
            showAlert('danger', 'Failed to load appointment details');
        });
}


function submitEditAppointment() {
    const form = document.getElementById('editAppointmentForm');
    const appointmentId = document.getElementById('editAppointmentId').value;
    // Collect form data manually for compatibility
    const appointment_date = document.getElementById('editAppointmentDate').value;
    const appointment_time = document.getElementById('editAppointmentTime').value;
    const symptoms = document.getElementById('editAppointmentSymptoms').value;
    const status = document.getElementById('editAppointmentStatus').value;
    const payload = new FormData(); // <-- Fix: declare payload before use
    payload.append('appointment_date', appointment_date);
    payload.append('appointment_time', appointment_time);
    payload.append('reason', symptoms); // Send as 'reason' to match backend
    payload.append('status', status);
    // Show loading state
    const submitBtn = document.querySelector('#editAppointmentModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;
    fetch(`{{ url_for("receptionist.edit_appointment_page", appointment_id=0) }}`.replace('0', appointmentId), {
            method: 'POST',
            body: payload
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
                modal.hide();
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showAlert('danger', data.message || 'Failed to update appointment');
            }
        })
        .catch(error => {
            console.error('Error updating appointment:', error);
            showAlert('danger', 'An error occurred while updating the appointment.');
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
}

function deleteAppointment(appointmentId) {
    if (!confirm('Are you sure you want to delete this appointment? This action cannot be undone.')) return;
    fetch(`{{ url_for('receptionist.receptionist_delete_appointment', appointment_id=0) }}`.replace('0', appointmentId), {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
            // No CSRF token sent
        }
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', data.message);
        }
    })
    .catch(err => {
        console.error('Delete error', err);
        showAlert('danger', 'Failed to delete appointment');
    });
}


function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : (type === 'danger' ? 'exclamation-triangle' : 'info-circle')} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.receptionist-card');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto remove after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

function openIntakeReadonly(patientId) {
    fetch(`/receptionist/patient/${patientId}/intake-readonly?ajax=1`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            if (html.trim().length === 0) {
                showAlert('info', 'No intake form found for this patient.');
                return;
            }
            document.getElementById('appointmentDetailsContent').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('appointmentDetailsModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading intake form:', error);
            showAlert('danger', 'Failed to load intake form.');
        });
}

function openTimelineModal(patientId) {
    const modalEl = document.getElementById('appointmentDetailsModal');
    if (!modalEl) {
        showAlert('danger', 'Timeline modal not found.');
        return;
    }
    const modal = new bootstrap.Modal(modalEl);
    // Show loading spinner
    const timelineContent = document.getElementById('appointmentDetailsContent');
    if (timelineContent) {
        timelineContent.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Loading timeline...</span>
                </div>
                <p class="mt-2 text-muted">Loading patient timeline...</p>
            </div>
        `;
    }
    modal.show();
    // Fetch timeline data
    fetch(`/doctor/patient/${patientId}/timeline?ajax=1`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(html => {
            if (timelineContent) {
                timelineContent.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading timeline:', error);
            if (timelineContent) {
                timelineContent.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                        <h5 class="text-danger">Failed to load timeline</h5>
                        <p class="text-muted">Please try again later.</p>
                        <button class="btn btn-primary" onclick="openTimelineModal('${patientId}')">
                            <i class="fas fa-redo me-1"></i>Retry
                        </button>
                    </div>
                `;
            }
        });
}

function viewPrescription(appointmentId) {
    fetch(`/receptionist/appointment/${appointmentId}/prescription-info`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.has_prescription && data.prescription_id) {
                fetch(`/receptionist/prescription/${data.prescription_id}/view?ajax=1`)
                    .then(resp => {
                        if (!resp.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return resp.text();
                    })
                    .then(html => {
                        if (html.trim().length === 0) {
                            showAlert('info', 'Prescription data not found.');
                            return;
                        }
                        document.getElementById('appointmentDetailsContent').innerHTML = html;
                        var modal = new bootstrap.Modal(document.getElementById('appointmentDetailsModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error loading prescription:', error);
                        showAlert('danger', 'Failed to load prescription details.');
                    });
            } else {
                showAlert('info', 'No prescription found for this appointment.');
            }
        })
        .catch(error => {
            console.error('Error loading prescription info:', error);
            showAlert('danger', 'Failed to load prescription details.');
        });
}

// Filtering logic
function filterAppointments() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const doctorValue = document.getElementById('doctorSelect').value;
    const dateValue = document.getElementById('dateInput').value;
    const rows = document.querySelectorAll('table tbody tr');
    rows.forEach(row => {
        let show = true;
        const patientName = row.cells[1].textContent.toLowerCase();
        const doctorId = row.getAttribute('data-doctor-id');
        const appointmentDate = row.cells[3].textContent;
        if (searchValue && !patientName.includes(searchValue)) show = false;
        if (doctorValue && doctorId !== doctorValue) show = false;
        if (dateValue && appointmentDate !== dateValue) show = false;
        row.style.display = show ? '' : 'none';
    });
}

function clearFilter(filterType) {
    const url = new URL(window.location);
    url.searchParams.delete(filterType);
    window.location.href = url.toString();
}
const searchEl = document.getElementById('search');
const doctorEl = document.getElementById('doctorSelect');
const dateEl = document.getElementById('date');

if (searchEl) searchEl.addEventListener('input', filterAppointments);
if (doctorEl) doctorEl.addEventListener('change', filterAppointments);
if (dateEl) dateEl.addEventListener('change', filterAppointments);
</script>
{% endblock %}